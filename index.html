<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mon Tr√©sor V7</title>
    
    <style>
        /* --- TH√àMES & VARIABLES --- */
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --gray: #8E8E93;
            --separator: #C6C6C8;
            --cal-bg: #F2F2F7;
            --cal-col-border: #E5E5EA;
            --cal-weekend: #EBEBF0;
            
            /* ZOOM DYNAMIQUE */
            --visible-days: 5; /* Valeur par d√©faut modifi√©e par le slider */
        }

        body.dark {
            --bg: #000000;
            --card: #1c1c1e;
            --text: #FFFFFF;
            --gray: #98989D;
            --separator: #38383A;
            --cal-bg: #000000;
            --cal-col-border: #38383A;
            --cal-weekend: #151516;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--card);
            padding: 15px 20px;
            padding-top: 50px;
            text-align: center;
            border-bottom: 1px solid var(--separator);
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            transition: transform 0.3s ease;
        }
        header.hidden { transform: translateY(-100%); }

        h1 { font-size: 13px; text-transform: uppercase; color: var(--gray); margin: 0; letter-spacing: 1px;}
        #total-capital { font-size: 34px; font-weight: 700; margin: 4px 0; }
        #auto-budget-indicator { font-size:12px; color: var(--gray); }

        /* --- VUES --- */
        .view-section { 
            display: none; height: 100%; box-sizing: border-box;
            padding-top: 140px; padding-bottom: 80px; overflow-y: auto;
        }
        .view-section.active { display: block; }

        #view-calendar.active {
            padding-top: 50px; padding-left: 0; padding-right: 0;
            overflow: hidden; background: var(--cal-bg);
        }

        /* --- LISTE --- */
        .transaction-card {
            background: var(--card); border-radius: 12px;
            padding: 15px; margin: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid transparent;
        }
        .t-info { flex-grow: 1; margin-left: 10px; }
        .t-title { font-weight: 600; font-size: 16px; }
        .t-date { font-size: 12px; color: var(--gray); margin-top: 3px;}
        .t-amount { font-weight: 700; font-size: 16px; }

        /* --- CALENDRIER (ZOOM & SNAPPING) --- */
        #cal-container {
            display: flex; height: 100%; overflow-x: auto; position: relative;
            background: var(--cal-bg);
            /* Snapping horizontal */
            scroll-snap-type: x mandatory;
        }
        
        .cal-col {
            /* Largeur dynamique calcul√©e selon le zoom */
            flex: 0 0 calc(100% / var(--visible-days));
            width: calc(100% / var(--visible-days));
            
            height: 100%; border-right: 1px solid var(--cal-col-border);
            box-sizing: border-box; display: flex; flex-direction: column; position: relative;
            
            /* Chaque colonne est un point d'accroche */
            scroll-snap-align: start;
        }
        
        .cal-col.weekend { background: var(--cal-weekend); }
        .cal-col.today { background: rgba(0, 122, 255, 0.05); }

        .cal-col-header {
            text-align: center; padding: 10px 0;
            border-bottom: 1px solid var(--cal-col-border);
            color: var(--gray); height: 50px; box-sizing: border-box;
            overflow: hidden;
        }
        .cal-day-name { font-size: 10px; text-transform: uppercase; display: block; }
        .cal-day-num { font-size: 18px; font-weight: 600; color: var(--text); }
        .today .cal-day-num { color: var(--primary); }

        /* Events Layer */
        #cal-events-layer {
            position: absolute; top: 50px; left: 0; bottom: 0; display: flex;
        }
        .event-block {
            position: absolute; height: 36px; border-radius: 6px;
            padding: 4px 6px; box-sizing: border-box; font-size: 10px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
            display: flex; flex-direction: column; justify-content: center;
            border-left-width: 4px; border-left-style: solid;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .event-title { font-weight: 700; color: var(--text); }
        .event-amt { opacity: 0.8; font-size: 9px; color: var(--text); }

        .col-balance {
            position: absolute; bottom: 40px; left: 0; right: 0; /* Remont√© pour le slider */
            text-align: center; font-size: 10px; font-weight: 600; color: var(--gray);
            pointer-events: none;
        }

        /* ZOOM SLIDER CONTROLS */
        #zoom-controls {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            width: 60%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
            padding: 5px 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 80;
        }
        body.dark #zoom-controls { background: rgba(30,30,30,0.8); }
        
        #zoom-slider { flex-grow: 1; accent-color: var(--primary); }
        .zoom-label { font-size: 10px; color: var(--gray); font-weight: bold; width: 30px; text-align: center;}


        /* --- R√âGLAGES (NOUVEAU DESIGN) --- */
        .simulator-box {
            background: var(--card); margin: 0 20px 20px 20px;
            border-radius: 12px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .week-stats-container {
            margin-top: 15px; border-top: 1px solid var(--separator); padding-top: 10px;
        }
        .week-row {
            display: flex; justify-content: space-between; font-size: 13px; 
            padding: 8px 0; border-bottom: 1px solid var(--separator);
        }
        .week-row:last-child { border-bottom: none; }

        .settings-group { background: var(--card); border-radius: 12px; padding: 15px; margin: 0 20px 20px 20px; }
        .settings-title { font-size: 13px; color: var(--gray); text-transform: uppercase; margin: 0 0 8px 30px; font-weight: 600;}
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }

        /* --- COULEURS PASTELS --- */
        .color-selector { display: flex; gap: 10px; overflow-x: auto; padding: 5px; }
        .color-option { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; flex-shrink: 0; }
        .color-option.selected { border-color: var(--text); transform: scale(1.1); }
        .c-white  { background: rgba(142, 142, 147, 0.15); border-left-color: #8E8E93 !important; }
        .c-red    { background: rgba(255, 59, 48, 0.15);   border-left-color: #FF3B30 !important; }
        .c-green  { background: rgba(52, 199, 89, 0.15);   border-left-color: #34C759 !important; }
        .c-blue   { background: rgba(0, 122, 255, 0.15);   border-left-color: #007AFF !important; }
        .c-yellow { background: rgba(255, 204, 0, 0.15);   border-left-color: #FFCC00 !important; }
        .c-orange { background: rgba(255, 149, 0, 0.15);   border-left-color: #FF9500 !important; }
        .c-purple { background: rgba(175, 82, 222, 0.15);  border-left-color: #AF52DE !important; }

        /* --- TAB BAR & FAB --- */
        .tab-bar {
            position: fixed; bottom: 0; width: 100%;
            background: var(--card);
            border-top: 1px solid var(--separator);
            display: flex; justify-content: space-around; padding: 10px 0 30px 0; z-index: 100;
        }
        .tab-btn { border: none; background: none; color: var(--gray); font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .tab-btn.active { color: var(--primary); }
        .tab-icon { font-size: 22px; margin-bottom: 2px; }

        .fab {
            position: fixed; bottom: 100px; right: 20px;
            background: var(--primary); color: white;
            width: 56px; height: 56px; border-radius: 28px;
            font-size: 28px; border: none; box-shadow: 0 4px 12px rgba(0,122,255,0.4);
            z-index: 90; display: flex; justify-content: center; align-items: center;
        }

        /* --- MODAL --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 200; align-items: flex-end;
        }
        .modal-content {
            background: var(--bg); width: 100%; border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input, select, textarea { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border: 1px solid var(--separator); border-radius: 10px; 
            font-size: 16px; box-sizing: border-box; font-family: inherit;
            background: var(--card); color: var(--text);
        }
        
    </style>
</head>
<body>

    <header id="main-header">
        <h1>Solde Actuel</h1>
        <div id="total-capital">...</div>
        <div id="auto-budget-indicator"></div>
    </header>

    <div id="view-list" class="view-section active">
        <div id="transaction-list"></div>
    </div>

    <div id="view-calendar" class="view-section">
        <div id="cal-container">
            <div id="cal-events-layer"></div>
        </div>
        
        <div id="zoom-controls">
            <span class="zoom-label">üîç-</span>
            <input type="range" id="zoom-slider" min="3" max="14" step="1" value="5" oninput="updateZoom(this.value)">
            <span class="zoom-label">üîç+</span>
        </div>
    </div>

    <div id="view-settings" class="view-section">
        
        <div class="simulator-box">
            <h3 style="margin-top:0; font-size:14px; text-transform:uppercase; color:var(--gray);">Visionneuse Temporelle</h3>
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
                <input type="date" id="sim-date" style="margin-bottom:0; width:auto;">
                <button onclick="runSimulation()" style="background:var(--primary); color:white; border:none; border-radius:10px; padding:0 20px; font-weight:bold;">VOIR</button>
            </div>
            
            <div id="sim-result" style="display:none; text-align:center;">
                <div style="font-size:12px; color:var(--gray);">Solde pr√©vu</div>
                <div id="sim-balance" style="font-size:28px; font-weight:800; margin:5px 0;"></div>
                <div id="sim-diff" style="font-size:13px; font-weight:600; margin-bottom:15px;"></div>
            </div>

            <h3 style="margin:20px 0 10px 0; font-size:12px; text-transform:uppercase; color:var(--gray); border-top:1px solid var(--separator); padding-top:15px;">
                D√©penses Hebdomadaires
            </h3>
            <div id="weekly-stats" class="week-stats-container">
                </div>
        </div>

        <div class="settings-title">Comptabilit√©</div>
        <div class="settings-group">
            <div class="setting-row">
                <label>Ajustement manuel du solde (‚Ç¨)</label>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="number" id="input-adjustment" placeholder="+/- Montant" style="margin-bottom:0;">
                <button onclick="applyAdjustment()" style="background:var(--primary); color:white; border:none; border-radius:8px; padding:0 15px; white-space:nowrap;">Valider</button>
            </div>
            <p style="font-size:11px; color:var(--gray); margin-top:5px;">
                Ceci cr√©era une transaction "Ajustement Manuel" pour corriger le solde.
            </p>
        </div>

        <div class="settings-title">Apparence & Auto</div>
        <div class="settings-group">
            <div class="setting-row">
                <label>Budget Hebdo Auto (‚Ç¨)</label>
                <input type="number" id="setting-weekly-budget" placeholder="0" onchange="saveSettings()" style="width:80px; margin:0; text-align:right;">
            </div>
            <div class="setting-row">
                <label>Mode Sombre (Dark)</label>
                <input type="checkbox" id="toggle-dark" onchange="toggleTheme()" style="width:auto; margin:0;">
            </div>
        </div>

        <div class="settings-title">Donn√©es</div>
        <div class="settings-group">
            <button onclick="exportData()" style="width:100%; padding:10px; margin-bottom:5px; background:var(--bg); border:1px solid var(--separator); border-radius:8px; color:var(--text);">Sauvegarder</button>
            <button onclick="importData()" style="width:100%; padding:10px; margin-bottom:5px; background:var(--bg); border:1px solid var(--separator); border-radius:8px; color:var(--text);">Importer</button>
            <button onclick="resetApp()" style="width:100%; padding:10px; background:transparent; border:1px solid #FF3B30; color:#FF3B30; border-radius:8px;">Reset Total</button>
        </div>
    </div>

    <button class="fab" onclick="openModal()">+</button>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('list')">
            <span class="tab-icon">‚ò∞</span> Liste
        </button>
        <button class="tab-btn" onclick="switchTab('calendar')">
            <span class="tab-icon">üìÖ</span> Calendrier
        </button>
        <button class="tab-btn" onclick="switchTab('settings')">
            <span class="tab-icon">‚öôÔ∏è</span> R√©glages
        </button>
    </nav>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0">Nouvel √âv√©nement</h2>
            <input type="hidden" id="edit-index" value="-1">

            <label>Titre</label>
            <input type="text" id="input-title" placeholder="Titre...">

            <label>Type</label>
            <select id="input-type" onchange="handleTypeChange()">
                <option value="expense">üìâ D√©pense</option>
                <option value="income">üìà Revenu</option>
                <option value="invest">‚è≥ Investissement (Bloqu√©)</option>
                <option value="event">üìù Note</option>
            </select>

            <label>Couleur</label>
            <div class="color-selector" id="color-picker">
                <div class="color-option c-white selected" onclick="selectColor('c-white')" style="background:#ddd;"></div>
                <div class="color-option c-red" onclick="selectColor('c-red')" style="background:#ffcccb;"></div>
                <div class="color-option c-green" onclick="selectColor('c-green')" style="background:#90ee90;"></div>
                <div class="color-option c-blue" onclick="selectColor('c-blue')" style="background:#add8e6;"></div>
                <div class="color-option c-orange" onclick="selectColor('c-orange')" style="background:#ffcc99;"></div>
                <div class="color-option c-purple" onclick="selectColor('c-purple')" style="background:#e0b0ff;"></div>
            </div>
            <input type="hidden" id="selected-color" value="c-white">
            <div style="margin-bottom:15px;"></div>

            <div id="group-amount">
                <label>Montant (‚Ç¨)</label>
                <input type="number" id="input-amount" placeholder="0.00" inputmode="decimal">
            </div>

            <label id="label-date-start">Date</label>
            <input type="date" id="input-date">
            
            <div id="group-date-end" style="display:none;">
                <label>Date de Retour</label>
                <input type="date" id="input-date-end">
            </div>
            
            <label>Notes</label>
            <textarea id="input-desc" rows="2" placeholder="D√©tails..."></textarea>

            <div style="display:flex; gap:10px;">
                <button onclick="closeModal()" style="flex:1; padding:15px; border-radius:12px; border:none; background:var(--separator); color:var(--text);">Annuler</button>
                <button onclick="saveTransaction()" style="flex:1; padding:15px; border-radius:12px; border:none; background:var(--primary); color:white; font-weight:bold;">Sauvegarder</button>
            </div>
            <button id="btn-delete" onclick="deleteCurrentItem()" style="width:100%; margin-top:10px; padding:15px; border:none; background:none; color:#FF3B30; display:none;">Supprimer</button>
        </div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('mb_transactions')) || [];
        // Note: initialCapital n'est plus utilis√© en V7, remplac√© par des transactions d'ajustement
        let settings = JSON.parse(localStorage.getItem('mb_settings')) || { weeklyBudget: 0, darkMode: false, zoom: 5 };
        let currentTab = 'list';
        let calendarStartDate = new Date();
        calendarStartDate.setDate(calendarStartDate.getDate() - 3);

        window.onload = function() {
            document.getElementById('setting-weekly-budget').value = settings.weeklyBudget || '';
            document.getElementById('toggle-dark').checked = settings.darkMode || false;
            
            // Restore Zoom
            if(settings.zoom) {
                document.getElementById('zoom-slider').value = settings.zoom;
                updateZoom(settings.zoom);
            }

            applyTheme();
            refreshUI();
        };

        // --- THEME & ZOOM ---
        function toggleTheme() {
            settings.darkMode = document.getElementById('toggle-dark').checked;
            saveData(); applyTheme();
        }
        function applyTheme() {
            if (settings.darkMode) document.body.classList.add('dark'); else document.body.classList.remove('dark');
            if(currentTab === 'calendar') renderOutlookCalendar();
        }
        function updateZoom(val) {
            settings.zoom = val;
            saveData();
            document.documentElement.style.setProperty('--visible-days', val);
            // Re-render needed to recalculate events positions if width changes drastically? 
            // Actually CSS handles width, but event left/width calc depends on 100/visible-days.
            // But since event calc uses vw units based on --column-width logic, we need to update var
            // Actually simpler: re-render calendar to be safe
            renderOutlookCalendar();
        }

        // --- DATA ---
        function saveData() {
            localStorage.setItem('mb_transactions', JSON.stringify(transactions));
            localStorage.setItem('mb_settings', JSON.stringify(settings));
        }

        function refreshUI() {
            calculateTotal();
            if (currentTab === 'list') renderList();
            if (currentTab === 'calendar') renderOutlookCalendar();
            if (currentTab === 'settings') renderWeeklyStats();
        }

        // --- LOGIC ---
        function getBalanceAtDate(targetDate) {
            let total = 0; // On part de 0, tout est transaction maintenant (y compris ajustements)
            const start = new Date(); start.setHours(0,0,0,0);
            const target = new Date(targetDate); target.setHours(0,0,0,0);

            transactions.forEach(t => {
                let dStart = new Date(t.date); dStart.setHours(0,0,0,0);
                
                if (t.type === 'invest') {
                    let dEnd = new Date(t.endDate); dEnd.setHours(0,0,0,0);
                    if (dStart <= target) total -= parseFloat(t.amount);
                    if (dEnd <= target) total += parseFloat(t.amount);
                } else {
                    if (dStart <= target) {
                        if (t.type === 'income') total += parseFloat(t.amount);
                        if (t.type === 'expense') total -= parseFloat(t.amount);
                    }
                }
            });

            // Budget auto
            const dailyBurn = (settings.weeklyBudget || 0) / 7;
            if (dailyBurn > 0 && target > start) {
                const diffTime = Math.abs(target - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                total -= (diffDays * dailyBurn);
            }
            return total;
        }

        function calculateTotal() {
            const today = new Date(); today.setHours(0,0,0,0);
            const total = getBalanceAtDate(today);
            document.getElementById('total-capital').innerText = total.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            
            const dailyBurn = (settings.weeklyBudget || 0) / 7;
            if (dailyBurn > 0) document.getElementById('auto-budget-indicator').innerText = `-${dailyBurn.toFixed(2)}‚Ç¨ / jour (Auto)`;
            return total;
        }

        function applyAdjustment() {
            const amountStr = document.getElementById('input-adjustment').value;
            if (!amountStr) return;
            const amount = parseFloat(amountStr);
            if (amount === 0) return;

            const t = {
                title: "Ajustement Manuel",
                type: amount >= 0 ? 'income' : 'expense',
                amount: Math.abs(amount),
                date: new Date().toISOString().split('T')[0],
                desc: "Correction de solde",
                color: 'c-white'
            };
            transactions.push(t);
            saveData();
            document.getElementById('input-adjustment').value = '';
            alert("Solde ajust√© !");
            refreshUI();
        }

        // --- STATS HEBDO ---
        function renderWeeklyStats() {
            const container = document.getElementById('weekly-stats');
            container.innerHTML = '';

            // Group by week
            const weeks = {};
            transactions.forEach(t => {
                if(t.type === 'expense') {
                    const d = new Date(t.date);
                    // Get Week Number (ISO)
                    const onejan = new Date(d.getFullYear(),0,1);
                    const millisecsInDay = 86400000;
                    const weekNum = Math.ceil((((d - onejan) /millisecsInDay) + onejan.getDay()+1)/7);
                    const key = `${d.getFullYear()}-S${weekNum}`;
                    
                    if(!weeks[key]) weeks[key] = 0;
                    weeks[key] += parseFloat(t.amount);
                }
            });

            // Sort keys descending (recent weeks first)
            const sortedKeys = Object.keys(weeks).sort().reverse();
            
            if(sortedKeys.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--gray); font-size:12px;">Aucune d√©pense enregistr√©e</div>';
                return;
            }

            sortedKeys.forEach(key => {
                container.innerHTML += `
                    <div class="week-row">
                        <span>${key}</span>
                        <span style="font-weight:bold; color:#FF3B30;">-${weeks[key].toFixed(2)} ‚Ç¨</span>
                    </div>
                `;
            });
        }

        // --- NAVIGATION ---
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabName).classList.add('active');
            
            // Header Toggle
            const header = document.getElementById('main-header');
            if (tabName === 'calendar') header.classList.add('hidden'); else header.classList.remove('hidden');

            const btnIndex = ['list', 'calendar', 'settings'].indexOf(tabName);
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');

            const fab = document.querySelector('.fab');
            if(tabName === 'settings') fab.style.display = 'none'; else fab.style.display = 'flex';

            refreshUI();
        }

        // --- SIMULATEUR ---
        function runSimulation() {
            const dateInput = document.getElementById('sim-date').value;
            if(!dateInput) return;
            const target = new Date(dateInput);
            const today = new Date(); today.setHours(0,0,0,0);
            const balance = getBalanceAtDate(target);
            const current = getBalanceAtDate(today);
            const diff = balance - current;

            document.getElementById('sim-balance').innerText = balance.toFixed(2) + ' ‚Ç¨';
            const diffEl = document.getElementById('sim-diff');
            diffEl.innerText = (diff >= 0 ? '+' : '') + diff.toFixed(2) + ' ‚Ç¨ vs Aujourd\'hui';
            diffEl.style.color = diff >= 0 ? '#34C759' : '#FF3B30';
            document.getElementById('sim-result').style.display = 'block';
        }

        // --- CALENDRIER (DYNAMIC) ---
        function renderOutlookCalendar() {
            const container = document.getElementById('cal-container');
            const eventsLayer = document.getElementById('cal-events-layer');
            
            // Cleanup columns
            document.querySelectorAll('.cal-col').forEach(e => e.remove());
            eventsLayer.innerHTML = '';

            const today = new Date(); today.setHours(0,0,0,0);
            
            for (let i = 0; i < 60; i++) {
                let curr = new Date(calendarStartDate);
                curr.setDate(calendarStartDate.getDate() + i);
                const isToday = curr.getTime() === today.getTime();
                const dayName = curr.toLocaleDateString('fr-FR', {weekday: 'short'});
                const dayNum = curr.getDate();
                const isWeekend = (curr.getDay() === 0 || curr.getDay() === 6);
                const balance = getBalanceAtDate(curr);

                const col = document.createElement('div');
                col.className = `cal-col ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`;
                col.innerHTML = `
                    <div class="cal-col-header">
                        <span class="cal-day-name">${dayName}</span>
                        <span class="cal-day-num">${dayNum}</span>
                    </div>
                    <div class="col-balance">${Math.round(balance)}</div>
                `;
                container.insertBefore(col, eventsLayer);
            }

            // Events
            const visibleDays = settings.zoom || 5;
            const vwUnit = 100 / visibleDays; // width % of one day

            transactions.forEach((t, index) => {
                let startDate = new Date(t.date);
                let endDate = (t.type === 'invest' && t.endDate) ? new Date(t.endDate) : new Date(t.date);
                
                const diffTime = startDate - calendarStartDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let duration = 1;
                if (t.type === 'invest') {
                    const durTime = endDate - startDate;
                    duration = Math.ceil(durTime / (1000 * 60 * 60 * 24)) + 1;
                }

                if (diffDays >= -duration && diffDays < 65) {
                    const el = document.createElement('div');
                    el.className = `event-block ${t.color || 'c-white'}`;
                    
                    let finalLeft = diffDays;
                    let finalWidth = duration;
                    if (diffDays < 0) { finalWidth = duration + diffDays; finalLeft = 0; }
                    
                    // Calc CSS based on dynamic width
                    el.style.left = `calc(${finalLeft} * ${vwUnit}%)`;
                    el.style.width = `calc(${finalWidth} * ${vwUnit}% - 4px)`;
                    el.style.top = (index % 10) * 40 + 'px';
                    
                    el.onclick = () => openModal(index);
                    
                    let icon = t.type === 'invest' ? '‚è≥ ' : '';
                    el.innerHTML = `
                        <div class="event-title">${icon}${t.title}</div>
                        <div class="event-amt">${t.type!=='event' && t.type!=='invest' ? t.amount+'‚Ç¨' : ''}</div>
                    `;
                    eventsLayer.appendChild(el);
                }
            });
        }

        // --- LISTE ---
        function renderList() {
            const listContainer = document.getElementById('transaction-list');
            listContainer.innerHTML = '';
            const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sorted.length === 0) listContainer.innerHTML = '<div style="text-align:center;color:var(--gray);margin-top:50px">Aucune op√©ration</div>';

            sorted.forEach((t) => {
                const index = transactions.indexOf(t);
                let amountHtml = '';
                if(t.type !== 'event') {
                    let color = 'var(--text)'; let sign = '';
                    if (t.type === 'income') { color = '#34C759'; sign = '+'; }
                    else if (t.type === 'expense') { color = '#FF3B30'; sign = '-'; }
                    else if (t.type === 'invest') { color = '#007AFF'; sign = '‚è≥ '; }
                    amountHtml = `<div class="t-amount" style="color:${color}">${sign}${parseFloat(t.amount).toFixed(2)}</div>`;
                }
                let dateTxt = new Date(t.date).toLocaleDateString('fr-FR');
                if (t.type === 'invest' && t.endDate) dateTxt += ' ‚ûî ' + new Date(t.endDate).toLocaleDateString('fr-FR');

                listContainer.innerHTML += `
                    <div class="transaction-card ${t.color || 'c-white'}" onclick="openModal(${index})">
                        <div class="t-info">
                            <div class="t-title">${t.title}</div>
                            <div class="t-date">${dateTxt}</div>
                        </div>
                        ${amountHtml}
                    </div>
                `;
            });
        }

        // --- FORMULAIRE ---
        const modal = document.getElementById('modal');
        function handleTypeChange() {
            const type = document.getElementById('input-type').value;
            const amtGroup = document.getElementById('group-amount');
            const dateEndGroup = document.getElementById('group-date-end');
            const lblStart = document.getElementById('label-date-start');

            if (type === 'event') amtGroup.style.display = 'none'; else amtGroup.style.display = 'block';
            if (type === 'invest') {
                dateEndGroup.style.display = 'block';
                lblStart.innerText = "D√©part";
            } else {
                dateEndGroup.style.display = 'none';
                lblStart.innerText = "Date";
            }
        }
        function selectColor(c) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector('.' + c).classList.add('selected');
            document.getElementById('selected-color').value = c;
        }
        function openModal(index = -1) {
            modal.style.display = 'flex';
            document.getElementById('edit-index').value = index;
            document.getElementById('input-title').value = '';
            document.getElementById('input-amount').value = '';
            document.getElementById('input-date').valueAsDate = new Date();
            document.getElementById('input-date-end').valueAsDate = new Date();
            document.getElementById('input-desc').value = '';
            document.getElementById('input-type').value = 'expense';
            selectColor('c-white');
            document.getElementById('btn-delete').style.display = 'none';

            if (index > -1) {
                const t = transactions[index];
                document.getElementById('modal-title').innerText = "Modifier";
                document.getElementById('input-title').value = t.title;
                document.getElementById('input-type').value = t.type;
                document.getElementById('input-amount').value = t.amount;
                document.getElementById('input-date').value = t.date;
                if(t.endDate) document.getElementById('input-date-end').value = t.endDate;
                document.getElementById('input-desc').value = t.desc || '';
                selectColor(t.color || 'c-white');
                document.getElementById('btn-delete').style.display = 'block';
            } else { document.getElementById('modal-title').innerText = "Nouveau"; }
            handleTypeChange();
        }
        function closeModal() { modal.style.display = 'none'; }
        
        function saveTransaction() {
            const index = parseInt(document.getElementById('edit-index').value);
            const title = document.getElementById('input-title').value;
            const type = document.getElementById('input-type').value;
            const amount = document.getElementById('input-amount').value;
            const date = document.getElementById('input-date').value;
            const endDate = document.getElementById('input-date-end').value;
            const desc = document.getElementById('input-desc').value;
            const color = document.getElementById('selected-color').value;

            if (!title || !date) return alert("Titre et Date requis");
            let finalEndDate = date;
            if (type === 'invest') finalEndDate = endDate || date;

            const item = { title, type, amount: (type==='event'?0:amount), date, endDate: finalEndDate, desc, color };
            if (index > -1) transactions[index] = item; else transactions.push(item);
            saveData(); closeModal(); refreshUI();
        }

        function deleteCurrentItem() {
            const index = parseInt(document.getElementById('edit-index').value);
            if (index > -1 && confirm("Supprimer ?")) {
                transactions.splice(index, 1);
                saveData(); closeModal(); refreshUI();
            }
        }
        function resetApp() { if(confirm("Effacer tout ?")) { localStorage.clear(); location.reload(); } }
        function exportData() { prompt("Copier :", JSON.stringify({t: transactions, s: settings})); }
        function importData() { const d = prompt("Coller :"); if(d) { try { const p=JSON.parse(d); transactions=p.t; settings=p.s; saveData(); location.reload(); } catch(e){alert("Erreur");} } }

    </script>
</body>
</html>
